<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Hürdenlauf-Spiel mit Münzen</title>
<style>
body {
    margin: 0;
    background-color: #111;
    overflow: hidden;
    font-family: Arial, sans-serif;
}
#gameArea {
    margin: auto;
    height: 100vh;
    display: flex;
    justify-content: flex-start;
    align-items: flex-end;
    position: relative;
    border: 10px solid #000;
    border-radius: 20px;
    box-shadow: inset 0 0 80px rgba(0,0,0,0.8);
    overflow: hidden;
}
#ground {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 40px;
    background: #444;
}
#player {
    position: absolute;
    bottom: 40px;
    left: 150px;
    width: 80px;
    height: 80px;
}
.hurdle {
    position: absolute;
    bottom: 40px;
    width: 158px;
    height: 70px;
    background: url('hurdle.png') no-repeat center/cover;
}
.hurdle-win {
    position: absolute;
    bottom: 40px;
    width: 158px;
    height: 70px;
    background: url('hurdle_win.png') no-repeat center/cover;
}
.coin {
    position: absolute;
    bottom: 40px; 
    width: 40px;
    height: 40px;
    background: url('coin.png') no-repeat center/cover;
}
#gameOver {
    position: absolute;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 28px;
    color: black;
    display: none;
    text-align: center;
}
#gameOver button {
    margin: 10px;
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-size: 18px;
    cursor: pointer;
}
#scoreBoard {
    position: absolute;
    top: 10px;
    right: 20px;
    font-size: 22px;
    color: white;
}
#coinsBoard {
    position: absolute;
    top: 40px;
    right: 20px;
    font-size: 20px;
    color: gold;
}
</style>
</head>
<body>
<div id="gameArea">
    <div id="ground"></div>
    <img id="player" src="run1.png" width="40" height="40">
    <div id="scoreBoard">Score: 0</div>
    <div id="coinsBoard">Coins: 0</div>
    <div id="gameOver">
        <div id="gameOverText">Game Over</div>
        <div id="rewardText"></div>
        <div id="finalScoreText"></div>
        <div id="highScoreText"></div>
        <button onclick="restartGame()">Neustart</button>
        <a href="menu.html"><button>Hauptmenü</button></a>
    </div>
</div>

<div id="healthBarContainer" style="
    position: absolute;
    top: 10px;
    left: 20px;
    width: 150px;
    height: 20px;
    border: 2px solid white;
    border-radius: 5px;
    background: #333;">
    <div id="healthBar" style="
        width: 100%;
        height: 100%;
        background: red;
        border-radius: 5px;"></div>
</div>

<script>

const gameArea = document.getElementById("gameArea");
const player = document.getElementById("player");
const gameOverScreen = document.getElementById("gameOver");
const rewardText = document.getElementById("rewardText");
const finalScoreText = document.getElementById("finalScoreText");
const highScoreText = document.getElementById("highScoreText");
const scoreBoard = document.getElementById("scoreBoard");
const coinsBoard = document.getElementById("coinsBoard");
const ground = document.getElementById("ground");

const groundHeight = 40;
let isJumping=false;
let jumpHeight=130

let jumpDuration=localStorage.getItem("jumpDuration") ? parseInt(localStorage.getItem("jumpDuration")) : 1200;

let obstacles=[];
const baseSpeedDefault=3;
let baseSpeed=baseSpeedDefault;
let minGap=600;
let maxGap=4000;

let score=0;
let coins=0;
let gameRunning=true;
let lastTime=performance.now();

let lastCollidedHurdle = null;

// Sprite Animation
const runSprites = [
    "run1.png","run2.png","run3.png","run4.png",
    "run5.png","run6.png","run7.png","run8.png"
];
const jumpSprite = "run8.png";
const deathSprites = ["death1.png", "death2.png", "death3.png", "death4.png"];
let currentRunIndex=0;
let lastFrameTime=performance.now();

//Health
const maxHealth = 3;
let currentHealth = maxHealth;
const healthBar = document.getElementById("healthBar");

let activeSkin = localStorage.getItem("activeSkin") || null;

function applySkinTheme(skinId){
    switch(skinId){
        case "flame":
            gameArea.style.background = "url('bg_flame.png') no-repeat center/cover";
            ground.style.background = "#880000";
            break;
        case "ice":
            gameArea.style.background = "url('bg_ice.png') no-repeat center/cover";
            ground.style.background = "#005f7f";
            break;
        case "galaxy":
            gameArea.style.background = "url('bg_galaxy.png') no-repeat center/cover";
            ground.style.background = "#220044";
            break;
        case "gold":
            gameArea.style.background = "url('bg_gold.png') no-repeat center/cover";
            ground.style.background = "#aa8800";
            break;
        default:
            gameArea.style.background="linear-gradient(160deg, #111, #333)";
            ground.style.background="#444";
    }
}
applySkinTheme(activeSkin);

updateHealthBar();

function updatePlayerSprite(time){
    if(!gameRunning && isDying){
        // Death animation handled separately
        return;
    }
    if(!gameRunning){
        player.src = deathSprites[deathSprites.length-1]; // Stay on last death frame if not animating
    } else if(isJumping){
        player.src = jumpSprite;
    } else {
        if(time - lastFrameTime > 100){ // adjust speed if needed
            currentRunIndex = (currentRunIndex + 1) % runSprites.length;
            player.src = runSprites[currentRunIndex];
            lastFrameTime = time;
        }
    }
    requestAnimationFrame(updatePlayerSprite);
}
updatePlayerSprite(performance.now());

function playDeathAnimation(callback) {
    isDying = true;
    let frame = 0;
    function nextFrame() {
        player.src = deathSprites[frame];
        frame++;
        if (frame < deathSprites.length) {
            setTimeout(nextFrame, 200);
        } else {
            // Stay on last frame
            isDying = false;
            if (callback) callback();
        }
    }
    nextFrame();
}

player.style.bottom = groundHeight + "px";

function handleJump(e){
    if(e.code === "Space") jump();
}
function handleMouseJump() { jump(); }
function handleTouchJump(e) { e.preventDefault(); jump(); }

document.addEventListener("keydown", handleJump);
gameArea.addEventListener("mousedown", handleMouseJump);
gameArea.addEventListener("touchstart", handleTouchJump, { passive: false });


function updateHealthBar() {
    const percent = (currentHealth / maxHealth) * 100;
    healthBar.style.width = percent + "%";
}

function jump(){
    if(!gameRunning) return;
    if(isJumping) return;

    // Dynamically adjust jump duration based on speed
    const speed = baseSpeed + score * 0.02;
    // The higher the speed, the shorter the jump duration (min 350ms)
    let dynamicJumpDuration = Math.max(350, jumpDuration * (baseSpeedDefault / speed));

    isJumping=true;
    const startTime = performance.now();
    function animate(time){
        const elapsed = Math.min(time-startTime, dynamicJumpDuration);
        const t = elapsed/dynamicJumpDuration;
        const y = jumpHeight*4*t*(1-t)+groundHeight;
        player.style.bottom = y+"px";
        if(elapsed<dynamicJumpDuration) requestAnimationFrame(animate);
        else {
            player.style.bottom=groundHeight+"px";
            isJumping=false;
        }
    }
    requestAnimationFrame(animate);
}

// Hürde oder Münze erstellen
function createObstacleOrCoin() {
    const isCoin = Math.random() < 0.2; // 20% Chance für Münze
    if(isCoin){
        const coin = document.createElement("div");
        coin.classList.add("coin");
        coin.style.left = gameArea.clientWidth + "px";
        gameArea.appendChild(coin);
        obstacles.push(coin);
    } else {
        const h = document.createElement("div");
        h.classList.add("hurdle");
        h.style.left = gameArea.clientWidth + "px";
        gameArea.appendChild(h);
        obstacles.push(h);
    }
}

//win hurdle
function spawnWinHurdle() {
    const winHurdle = document.createElement("div");
    winHurdle.classList.add("hurdle-win");
    winHurdle.style.left = (180) + "px";
    gameArea.appendChild(winHurdle);
}

// Game Loop
function gameLoop(time){
    if(!gameRunning) return;
    let delta=(time-lastTime)/1000;
    lastTime=time;

    score+=delta*5;
    scoreBoard.textContent="Score: "+Math.floor(score);

    const speed=baseSpeed+score*0.02;

    obstacles.forEach((obj,index)=>{
    let left=parseFloat(obj.style.left);
    left-=speed;
    obj.style.left=left+"px";

    if(left<-50){
        if(gameArea.contains(obj)) gameArea.removeChild(obj);
        obstacles.splice(index,1);
    }

    // --- HITBOX SHRINKING ---
    // Shrink hitboxes by 20% on each side (adjust as needed)
    const playerMarginX = player.offsetWidth * 0.2;
    const objMarginX = obj.offsetWidth * 0.2;

    const playerLeft = player.offsetLeft + playerMarginX;
    const playerRight = player.offsetLeft + player.offsetWidth - playerMarginX;
    const playerBottom = (parseFloat(player.style.bottom)||groundHeight);
    const playerTop = (parseFloat(player.style.bottom)||groundHeight) + player.offsetHeight;

    const objLeft = left + objMarginX;
    const objRight = left + obj.offsetWidth - objMarginX;
    const objBottom = (obj.classList.contains("hurdle") ? groundHeight : parseFloat(obj.style.bottom)||100);
    const objTop = objBottom + obj.offsetHeight;

    if(playerRight>objLeft && playerLeft<objRight &&
       playerBottom<objTop && playerTop>objBottom){

    if(obj.classList.contains("hurdle")){
        currentHealth--;
        updateHealthBar();
    if(currentHealth <=0) {
        lastCollidedHurdle = obj;
        gameOver();
    }
        } else if(obj.classList.contains("coin")){
            coins += 5; // Münze gibt 5 Coins
            coinsBoard.textContent = "Coins: " + coins;
        }

        if(gameArea.contains(obj)) gameArea.removeChild(obj);
        obstacles.splice(index,1);
    }
});

    const lastObstacle = obstacles[obstacles.length-1];
    const gap = Math.random()*(maxGap-minGap)+minGap;
    if(!lastObstacle || parseFloat(lastObstacle.style.left)<gameArea.clientWidth-gap){
        createObstacleOrCoin();
    }

    requestAnimationFrame(gameLoop);
}

// Game Over
function gameOver(){
    spawnWinHurdle();
    document.removeEventListener("keydown", handleJump);
    gameArea.removeEventListener("mousedown", handleMouseJump);
    gameArea.removeEventListener("touchstart", handleTouchJump, { passive: false });
    gameRunning=false;
    gameOverScreen.style.display="block";

    // Set background to red on death
    gameArea.style.background = "red";

    let highscore=parseInt(localStorage.getItem("highscore"))||0;
    if(score>highscore) localStorage.setItem("highscore", Math.floor(score));

    // Coins aus Score: je 10 Punkte = 1 Münze
    const coinsFromScore = Math.floor(score/10);
    coins += coinsFromScore;

    // Play death animation, then show game over info
    playDeathAnimation(() => {
        // Coins in localStorage speichern
        let totalCoins = parseInt(localStorage.getItem("coins"))||0;
        totalCoins += coins;
        localStorage.setItem("coins", totalCoins);

        rewardText.textContent = `+${coins} Münzen gesammelt (insgesamt: ${totalCoins})`;
        finalScoreText.textContent = `Score: ${Math.floor(score)}`;
        highScoreText.textContent = `Highscore: ${Math.floor(Math.max(score, highscore))}`;
    });
}

// Restart
function restartGame(){
    gameOverScreen.style.display="none";
    player.style.bottom = groundHeight + "px";
    isJumping=false;
    obstacles.forEach(h=>{if(gameArea.contains(h)) gameArea.removeChild(h);});
    obstacles=[];
    score=0;
    coins=0;
    coinsBoard.textContent = "Coins: 0";
    baseSpeed=baseSpeedDefault;
    lastTime=performance.now();
    gameRunning=true;

    // Remove win hurdle if present
    const winHurdle = document.querySelector('.hurdle-win');
    if(winHurdle && gameArea.contains(winHurdle)) {
        gameArea.removeChild(winHurdle);
    }

    obstacles.forEach(h=>{if(gameArea.contains(h)) gameArea.removeChild(h);});
    obstacles=[];

    currentHealth = maxHealth;
    updateHealthBar();

    isDying = false;
    currentRunIndex = 0;
    player.src = runSprites[0];

    // Restore background to normal (with skin support)
    applySkinTheme(activeSkin);

    updatePlayerSprite(performance.now());

    document.addEventListener("keydown", handleJump);
    gameArea.addEventListener("mousedown", handleMouseJump);
    gameArea.addEventListener("touchstart", handleTouchJump, { passive: false });
    gameLoop(performance.now());
}

// Start
gameLoop(performance.now());
</script>
</body>
</html>
